# chatbot.py
# This file contains the core logic and state management for the financial chatbot.

from datetime import datetime
import random

class FinanceChatbot:
    """
    Manages the user's profile, financial data, and conversation history.
    Contains the primary logic for handling data entry and generating summaries.
    """
    def __init__(self):
        """Initializes the chatbot's state."""
        self.user_profile = {}
        self.financial_data = {'income': [], 'expenses': [], 'savings': []}
        self.conversation_history = []

    def set_user_profile(self, age, income, location, family_size, risk_tolerance):
        """Saves the user's profile information."""
        self.user_profile = {
            'age': age, 'income': income, 'location': location,
            'family_size': family_size, 'risk_tolerance': risk_tolerance
        }
        return f"‚úÖ Profile saved! Age: {age}, Income: ‚Çπ{income:,.2f}, Location: {location}, Family: {family_size}, Risk: {risk_tolerance}"

    def add_financial_data(self, data_type, amount, description, category=""):
        """Adds a single financial entry (income, expense, or saving)."""
        if amount is None or description is None:
            return "‚ùå Amount and description are required."
        try:
            entry = {
                'date': datetime.now().strftime('%Y-%m-%d'),
                'amount': float(amount),
                'description': description,
                'category': category
            }
            if data_type in self.financial_data:
                self.financial_data[data_type].append(entry)
                return f"‚úÖ Added {data_type}: ‚Çπ{amount:,.2f} - {description}"
            return "‚ùå Invalid data type"
        except (ValueError, TypeError):
            return "‚ùå Invalid amount provided."

    def add_multiple_entries(self, text_input, data_type):
        """
        Parses a block of text to add multiple financial entries.
        
        Args:
            text_input (str): The multi-line string with financial data.
            data_type (str): The type of data ('expenses' or 'income').
        """
        if not text_input or not text_input.strip():
            return "‚ùå Input text cannot be empty."
            
        try:
            lines = text_input.strip().split('\n')
            added_count = 0
            total_amount = 0
            results = []
            
            for line in lines:
                line = line.strip()
                if not line:
                    continue
                
                parts = [part.strip() for part in line.split(',')]
                
                if len(parts) >= 2:
                    try:
                        amount = float(parts[0])
                        description = parts[1]
                        
                        if data_type == 'expenses':
                            category = parts[2] if len(parts) > 2 else "Other"
                            self.add_financial_data('expenses', amount, description, category)
                            results.append(f"‚úÖ ‚Çπ{amount:,.2f} - {description} ({category})")
                        else: # income
                            self.add_financial_data('income', amount, description, "Income")
                            results.append(f"‚úÖ ‚Çπ{amount:,.2f} - {description}")

                        added_count += 1
                        total_amount += amount
                        
                    except ValueError:
                        results.append(f"‚ùå Invalid amount in line: {line}")
                else:
                    results.append(f"‚ùå Invalid format in line: {line}")
            
            summary = f"\nüìä **Summary**: Added {added_count} {data_type} totaling ‚Çπ{total_amount:,.2f}"
            return "\n".join(results) + summary
            
        except Exception as e:
            return f"‚ùå Error processing entries: {str(e)}"

    def generate_budget_summary(self):
        """Generates a summary of the user's budget based on stored data."""
        total_income = sum(entry['amount'] for entry in self.financial_data['income'])
        total_expenses = sum(entry['amount'] for entry in self.financial_data['expenses'])
        total_savings = sum(entry['amount'] for entry in self.financial_data['savings'])

        summary = f"""
üìä **Budget Summary**

üí∞ **Total Income**: ‚Çπ{total_income:,.2f}
üí∏ **Total Expenses**: ‚Çπ{total_expenses:,.2f}
üíæ **Total Savings**: ‚Çπ{total_savings:,.2f}
üìà **Net Cash Flow**: ‚Çπ{total_income - total_expenses:,.2f}

üéØ **Recommendations**:
"""
        
        if total_income > 0:
            if total_expenses > total_income * 0.8:
                summary += "‚Ä¢ Your expenses are high relative to income. Consider reducing non-essential spending.\n"
            if total_savings < total_income * 0.1:
                summary += "‚Ä¢ Aim to save at least 10-20% of your income for emergencies and future goals.\n"
        
        if total_income - total_expenses > 0:
            summary += "‚Ä¢ Great job! You have positive cash flow. Consider investing the surplus.\n"
        else:
            summary += "‚Ä¢ You're spending more than you earn. Focus on reducing expenses or increasing income.\n"

        return summary

    def get_investment_advice(self):
        """Generates personalized investment advice based on user profile."""
        if not self.user_profile:
            return "Please set up your profile in the 'üë§ Profile Setup' tab first for personalized investment advice."
        
        age = self.user_profile.get('age', 30)
        risk_tolerance = self.user_profile.get('risk_tolerance', 'Moderate')
        income = self.user_profile.get('income', 0)
        
        # Calculate recommended allocation
        equity_allocation = {
            'Conservative': 40,
            'Moderate': 60,
            'Aggressive': 80
        }.get(risk_tolerance, 60)
        
        # Adjust equity allocation based on age
        if age < 30:
            equity_allocation += 10
        elif age > 50:
            equity_allocation -= 10
        
        debt_allocation = 100 - equity_allocation
        monthly_investment = income * 0.3  # Recommend 30% of income for investments
        
        advice = f"""
üí° **Personalized Investment Strategy**:

Based on your profile:
‚Ä¢ Age: {age} years
‚Ä¢ Risk Tolerance: {risk_tolerance}
‚Ä¢ Monthly Income: ‚Çπ{income:,.2f}
‚Ä¢ Recommended Monthly Investment: ‚Çπ{monthly_investment:,.2f}

**Suggested Portfolio Allocation**:
‚Ä¢ üìà Equity: {equity_allocation}% (‚Çπ{monthly_investment * equity_allocation/100:,.2f}/month)
‚Ä¢ üè¶ Debt: {debt_allocation}% (‚Çπ{monthly_investment * debt_allocation/100:,.2f}/month)

**Investment Options for Your Profile**:
"""
        # Age-based specific recommendations
        if age < 30:
            advice += """
üéØ **Young Investor Focus**:
‚Ä¢ Higher equity exposure for long-term growth
‚Ä¢ Start SIPs in equity mutual funds
‚Ä¢ Consider aggressive growth stocks
‚Ä¢ Begin retirement planning early
"""
        elif age < 45:
            advice += """
üéØ **Mid-Career Focus**:
‚Ä¢ Balanced portfolio with growth and stability
‚Ä¢ Mix of equity and debt mutual funds
‚Ä¢ Consider real estate investment
‚Ä¢ Maximize tax-saving investments
"""
        else:
            advice += """
üéØ **Pre-Retirement Focus**:
‚Ä¢ Focus on capital preservation
‚Ä¢ Increase allocation to debt instruments
‚Ä¢ Consider dividend-paying stocks
‚Ä¢ Look into senior citizen saving schemes
"""

        # Risk tolerance based recommendations
        advice += "\n**Based on Your Risk Profile**:"
        if risk_tolerance == 'Conservative':
            advice += """
‚Ä¢ üè¶ Fixed Income (50-60%):
  - Bank Fixed Deposits
  - Government Bonds
  - Corporate Bonds (AAA-rated)
  - Post Office Schemes

‚Ä¢ üìä Equity (30-40%):
  - Large-cap Mutual Funds
  - Blue-chip Stocks
  - Index Funds
  - Balanced Advantage Funds

‚Ä¢ üè∞ Alternative (0-10%):
  - Gold ETFs
  - REITs
"""
        elif risk_tolerance == 'Moderate':
            advice += """
‚Ä¢ üìä Equity (50-60%):
  - Large-cap Funds (30%)
  - Mid-cap Funds (20%)
  - Index Funds (10%)
  
‚Ä¢ üè¶ Fixed Income (30-40%):
  - Corporate Bonds
  - Government Securities
  - Banking & PSU Debt Funds
  
‚Ä¢ üè∞ Alternative (10-20%):
  - REITs
  - Gold Funds
  - International Funds
"""
        else:  # Aggressive
            advice += """
‚Ä¢ üìä Equity (70-80%):
  - Mid-cap Funds (30%)
  - Small-cap Funds (20%)
  - Sectoral Funds (20%)
  - International Funds (10%)
  
‚Ä¢ üè¶ Fixed Income (10-20%):
  - Dynamic Bond Funds
  - Credit Risk Funds
  
‚Ä¢ üè∞ Alternative (10-20%):
  - Small-cap Direct Stocks
  - Commodity Funds
  - Crypto Funds (if allowed)
"""

        # Tax-saving investment suggestions
        monthly_80c = min(income * 0.15, 12500)  # 1.5L yearly limit
        advice += f"""
\nüí∞ **Tax-Saving Investment Options**:
‚Ä¢ Recommended Monthly Tax-Saving: ‚Çπ{monthly_80c:,.2f}
‚Ä¢ ELSS Mutual Funds
‚Ä¢ PPF (Public Provident Fund)
‚Ä¢ NPS (National Pension System)
‚Ä¢ Term Insurance Premiums
‚Ä¢ Tax-Saving Fixed Deposits
"""

        # Market-specific advice
        advice += """
\nüìà **Current Market Strategy**:
‚Ä¢ Do systematic investment planning (SIP)
‚Ä¢ Diversify across market caps
‚Ä¢ Consider international diversification
‚Ä¢ Review and rebalance quarterly
‚Ä¢ Keep emergency fund separate
"""
            
        return advice

    def get_savings_advice(self):
        """Generates personalized savings advice based on financial data."""
        total_income = sum(entry['amount'] for entry in self.financial_data['income'])
        total_expenses = sum(entry['amount'] for entry in self.financial_data['expenses'])
        total_savings = sum(entry['amount'] for entry in self.financial_data['savings'])
        
        if total_income == 0:
            return "Please add your income details in the 'üí∞ Financial Data' tab for personalized savings advice."
        
        current_savings_rate = (total_savings / total_income * 100) if total_income > 0 else 0
        monthly_expenses = total_expenses
        age = self.user_profile.get('age', 30) if self.user_profile else 30
        
        advice = f"""
üí∞ **Comprehensive Savings Plan**:

Current Status:
‚Ä¢ Monthly Income: ‚Çπ{total_income:,.2f}
‚Ä¢ Monthly Expenses: ‚Çπ{monthly_expenses:,.2f}
‚Ä¢ Current Savings Rate: {current_savings_rate:.1f}%
‚Ä¢ Net Monthly Surplus: ‚Çπ{total_income - monthly_expenses:,.2f}

üéØ **Essential Financial Goals**:

1. üö® **Emergency Fund**
   ‚Ä¢ Target: {6}-{12} months of expenses
   ‚Ä¢ Required: ‚Çπ{monthly_expenses * 6:,.2f} - ‚Çπ{monthly_expenses * 12:,.2f}
   ‚Ä¢ Keep in high-liquidity options like:
     - Savings Account
     - Short-term Fixed Deposits
     - Liquid Mutual Funds

2. üè• **Insurance Coverage**
   ‚Ä¢ Health Insurance: ‚Çπ{max(500000, monthly_expenses * 24):,.0f} minimum coverage
   ‚Ä¢ Term Life: {max(10, round(total_income * 12 * 10 / 100000) / 10)}Cr coverage suggested
   ‚Ä¢ Critical Illness Cover: ‚Çπ{monthly_expenses * 36:,.0f}

3. üí∞ **Monthly Savings Allocation**
   ‚Ä¢ Minimum Target: 20% (‚Çπ{total_income * 0.2:,.2f})
   ‚Ä¢ Ideal Target: 30% (‚Çπ{total_income * 0.3:,.2f})
   ‚Ä¢ Your Potential: ‚Çπ{total_income - monthly_expenses:,.2f}

   Suggested Split:
   ‚Ä¢ Emergency Fund: 40% until target reached
   ‚Ä¢ Retirement: 30%
   ‚Ä¢ Short-term goals: 20%
   ‚Ä¢ Discretionary: 10%

4. üéì **Goal-based Savings**
   Short-term (1-3 years):
   ‚Ä¢ Build emergency fund
   ‚Ä¢ Save for large purchases
   ‚Ä¢ Create a debt repayment plan

   Medium-term (3-7 years):
   ‚Ä¢ House down payment
   ‚Ä¢ Higher education
   ‚Ä¢ Vehicle purchase

   Long-term (7+ years):
   ‚Ä¢ Retirement corpus
   ‚Ä¢ Children's education
   ‚Ä¢ Wealth creation

5. üìà **Retirement Planning**"""
        
        # Add retirement-specific advice based on age
        if age < 30:
            advice += f"""
   ‚Ä¢ Start Early Advantage
   ‚Ä¢ Target Retirement Corpus: ‚Çπ{total_income * 12 * 25:,.0f}
   ‚Ä¢ Required Monthly Saving: ‚Çπ{(total_income * 12 * 25)/(35 * 12):,.0f}
   ‚Ä¢ Focus on equity-heavy portfolio"""
        elif age < 45:
            advice += f"""
   ‚Ä¢ Mid-Career Planning
   ‚Ä¢ Target Retirement Corpus: ‚Çπ{total_income * 12 * 20:,.0f}
   ‚Ä¢ Required Monthly Saving: ‚Çπ{(total_income * 12 * 20)/(20 * 12):,.0f}
   ‚Ä¢ Balance between equity and debt"""
        else:
            advice += f"""
   ‚Ä¢ Pre-Retirement Strategy
   ‚Ä¢ Target Retirement Corpus: ‚Çπ{total_income * 12 * 15:,.0f}
   ‚Ä¢ Required Monthly Saving: ‚Çπ{(total_income * 12 * 15)/(10 * 12):,.0f}
   ‚Ä¢ Focus on capital preservation"""

        advice += """

üí° **Smart Saving Strategies**:
1. Automate your savings (set up auto-debit)
2. Use the 50-30-20 rule:
   ‚Ä¢ 50% for needs
   ‚Ä¢ 30% for wants
   ‚Ä¢ 20% for savings
3. Track expenses regularly
4. Review and adjust monthly
5. Consider tax-saving investments
6. Build multiple income streams
"""

        # Add specific recommendations based on savings rate
        if current_savings_rate < 10:
            advice += """
üö© **Priority Actions**:
‚Ä¢ Cut non-essential expenses
‚Ä¢ Look for additional income sources
‚Ä¢ Renegotiate bills and subscriptions
‚Ä¢ Create a strict budget
‚Ä¢ Focus on building emergency fund first"""
        elif current_savings_rate < 20:
            advice += """
üìà **Next Steps**:
‚Ä¢ Increase savings by 5% every 6 months
‚Ä¢ Start investment SIPs
‚Ä¢ Optimize tax savings
‚Ä¢ Build emergency fund
‚Ä¢ Review insurance coverage"""
        else:
            advice += """
üåü **Growth Opportunities**:
‚Ä¢ Maximize retirement contributions
‚Ä¢ Explore investment opportunities
‚Ä¢ Consider real estate investment
‚Ä¢ Start tax planning early
‚Ä¢ Look into passive income sources"""

        return advice

    def chat_response(self, message, history):
        """Generates a contextual response to a user's chat message."""
        message_lower = message.lower()
        
        if any(word in message_lower for word in ['invest', 'stock', 'share', 'market', 'portfolio', 'mutual fund']):
            if 'stock' in message_lower and 'analysis' in message_lower:
                response = "I can help with stock analysis! Use the 'üìà Stock Analysis' tab to get live data. Just enter a stock symbol like 'RELIANCE.BSE' or 'AAPL'."
            else:
                response = self.get_investment_advice()
        elif any(word in message_lower for word in ['credit', 'score', 'rating']):
            response = "I can help you estimate your credit score! Use the 'üèÜ Credit Score' tab to input your financial information and get a comprehensive analysis."
        elif any(word in message_lower for word in ['budget', 'spending', 'money']):
            response = "Budgeting is key! Add your income and expenses in the 'üí∞ Financial Data' tab, then click 'Generate Budget Summary' in the 'üìä Analysis & Insights' tab."
        elif any(word in message_lower for word in ['save', 'savings', 'emergency fund']):
            response = self.get_savings_advice()
        else:
            responses = [
                "I'm here to help with your financial questions! I can assist with budgeting, stock analysis, credit scores, and more.",
                "I'm your AI financial assistant! Feel free to ask about personal finance, or use the tabs to analyze your budget, stocks, or credit score."
            ]
            response = random.choice(responses)

        self.conversation_history.append({
            'user': message,
            'assistant': response,
            'timestamp': datetime.now().isoformat()
        })
        return response
